name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions üöÄ
on: [push]
env:
  REPOSITORY: my-repository
  PROJECT: buta-chan
  LOCATION: asia-northeast1
  SERVICE: my-service
  CLOUD_SQL_INSTANCE: my-sql-instance

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    permissions:
      id-token: "write"
    steps:
      - name: Checkout
        uses: "actions/checkout@v3"
      - run: 'echo "$TEST" > key'
        shell: bash
        env:
          TEST: ${{secrets.TEST}}
      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v0'
        with:
          workload_identity_provider: 'projects/61926662696/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
          service_account: 'cloud-run-deploy-preview@buta-chan.iam.gserviceaccount.com'
      - name: Setup Cloud SDK
        uses: "google-github-actions/setup-gcloud@v0"
      - name: Describe my-service-account
        run: gcloud iam service-accounts describe cloud-run-deploy-preview@buta-chan.iam.gserviceaccount.com
      # - name: Configure docker
      #   run: gcloud auth configure-docker ${{ secrets.TEST }}-docker.pkg.dev
      - name: Build image
        run: |
          docker build -t ${{ secrets.TEST }}-docker.pkg.dev/${{ env.PROJECT }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }} -f ./Dockerfile .
      
      # gcloud auth configure-docker „ÅÆÂæå„Åß„ÅÇ„Çå„Å∞Artifact Registry„Å∏ docker push „Åô„Çã„Åì„Å®„Åå„Åß„Åç„Çã
      - name: Publish image to Google Artifact Registry
        run: |
          docker push ${{ env.LOCATION }}-docker.pkg.dev/${{ env.PROJECT }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }}
      
